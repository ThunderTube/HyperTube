<!DOCTYPE html>

<title>Torrent Stream Tests</title>

<video id="video" controls></video>

<script>
    function app() {
        const params = new URLSearchParams(window.location.search);

        const ID = params.get('id');
        const RESOLUTION = params.get('resolution');
        console.log(ID, RESOLUTION);
        if (!(ID && RESOLUTION)) {
            return;
        }

        const source = document.getElementById('source');
        const video = document.getElementById('video');

        fetch(`/api/v1/stream/video/download/${ID}/${RESOLUTION}`)
            .then(res => res.text())
            .then(state => {
                console.log('state =', state);
            });

        const intervalId = setInterval(poll, 10_000);
        poll();

        function poll() {
            fetch(`/api/v1/stream/video/status/${ID}/${RESOLUTION}`)
                .then(res => {
                    if (res.status !== 200) {
                        throw new Error('Bad response');
                    }
                    return res.text();
                })
                .then(state => {
                    if (['FIRST_CHUNKS_LOADED', 'LOADED'].includes(state)) {
                        addSource(
                            `/video/chunks/${ID}/${RESOLUTION}`,
                            'video/mp4'
                        );

                        clearInterval(intervalId);
                        return;
                    }

                    console.log('poll state =', state);
                })
                .catch(console.error);
        }

        function addSource(url, type) {
            const source = document.createElement('source');
            source.src = url;
            source.type = type;

            video.appendChild(source);
        }
    }

    app();
</script>
